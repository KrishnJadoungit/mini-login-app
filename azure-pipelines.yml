trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  EC2_PUBLIC_IP: $(EC2_PUBLIC_IP)
  EC2_SSH_KEY: $(EC2_SSH_KEY)

jobs:
- job: Deploy
  steps:
  - task: Bash@3
    displayName: "🔐 Decode SSH key"
    inputs:
      targetType: inline
      script: |
        ssh_key_file="ec2-key.pem"
        echo "${EC2_SSH_KEY}" | base64 -d > $ssh_key_file
        chmod 600 $ssh_key_file
        ls -l $ssh_key_file

  - task: Bash@3
    displayName: "🚀 Deploy to EC2"
    inputs:
      targetType: inline
      script: |
        ssh_key_file="ec2-key.pem"
        ssh -o StrictHostKeyChecking=no -i $ssh_key_file ec2-user@${EC2_PUBLIC_IP} << 'EOF'
          cd ~/mini-login-app
          git pull origin main
          npm install
          pm2 restart all
        EOF
