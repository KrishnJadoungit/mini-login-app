trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  - group: EC2Secrets  # Ye group jisme tumhara SSH_KEY aur PUBLIC_IP hai

jobs:
- job: DeployDocker
  displayName: "🐳 Deploy with Docker"
  steps:
    - task: Bash@3
      displayName: "🔑 Decode PEM Key"
      inputs:
        targetType: inline
        script: |
          echo "$(EC2_SSH_KEY)" | base64 -d > ec2-key.pem
          chmod 600 ec2-key.pem

    - task: Bash@3
      displayName: "🚀 SSH to EC2 and Deploy Container"
      inputs:
        targetType: inline
        script: |
          ssh -o StrictHostKeyChecking=no -i ec2-key.pem ec2-user@$(EC2_PUBLIC_IP) << 'EOF'
            docker pull jadoun/mini-login-app:latest
            docker stop mini-login-app || true
            docker rm mini-login-app || true
            docker run -d -p 80:3000 --name mini-login-app jadoun/mini-login-app:latest
            docker ps
          EOF
