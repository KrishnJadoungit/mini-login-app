trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

jobs:
- job: Deploy
  variables:
    ssh_key_file: ec2-key.pem

  steps:
  - task: Bash@3
    displayName: "🔐 Decode SSH Key"
    inputs:
      targetType: inline
      script: |
        echo "$(EC2_SSH_KEY)" | base64 -d > $(ssh_key_file)
        chmod 600 $(ssh_key_file)

  - task: Bash@3
    displayName: "🚀 SSH and Deploy"
    inputs:
      targetType: inline
      script: |
        ssh -o StrictHostKeyChecking=no -i $(ssh_key_file) ec2-user@$(EC2_PUBLIC_IP) << 'EOF'
          cd ~/mini-login-app
          git pull origin main
          npm install
          pm2 restart all
        EOF
