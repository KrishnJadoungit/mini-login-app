trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  - group: EC2Secrets   # âœ… Make sure youâ€™ve linked this in your pipeline Library

jobs:
# -------------------------------------------
# 1ï¸âƒ£ BUILD & PUSH DOCKER IMAGE
# -------------------------------------------
- job: BuildAndPush
  displayName: "ðŸ³ Build & Push Docker Image"
  steps:
    - checkout: self

    - task: Bash@3
      displayName: "ðŸ”‘ Docker Login & Build"
      inputs:
        targetType: inline
        script: |
          echo "$(DOCKER_PASSWORD)" | docker login -u $(DOCKER_USERNAME) --password-stdin
          docker build -t jadoun/mini-login-app:latest .
          docker push jadoun/mini-login-app:latest

# -------------------------------------------
# 2ï¸âƒ£ DEPLOY TO EC2
# -------------------------------------------
- job: Deploy
  dependsOn: BuildAndPush
  displayName: "ðŸš€ SSH to EC2 & Deploy Container"
  steps:

    - task: Bash@3
      name: DecodeKey
      displayName: "ðŸ” Decode EC2 SSH Key"
      inputs:
        targetType: inline
        script: |
          echo "$(EC2_SSH_KEY)" | base64 -d > ec2-key.pem
          chmod 600 ec2-key.pem
          ls -l ec2-key.pem

    - task: Bash@3
      displayName: "ðŸ“¡ SSH Pull & Run Docker Container"
      inputs:
        targetType: inline
        script: |
          ssh -o StrictHostKeyChecking=no -i ec2-key.pem ec2-user@$(EC2_PUBLIC_IP) << 'EOF'
            docker pull jadoun/mini-login-app:latest
            docker stop mini-login-app || true
            docker rm mini-login-app || true
            docker run -d -p 80:3000 --name mini-login-app jadoun/mini-login-app:latest
            docker ps
          EOF
