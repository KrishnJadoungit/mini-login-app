trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  ssh_key_file: ec2-key.pem
  ec2_user: ec2-user
  ec2_ip: $(EC2_PUBLIC_IP)
  ssh_key_base64: $(EC2_SSH_KEY)

jobs:
- job: Deploy
  steps:
    - script: |
        echo "$(ssh_key_base64)" | base64 -d > $(ssh_key_file)
        chmod 600 $(ssh_key_file)
      displayName: "🔐 Decode SSH Key"

    - script: |
        ssh -o StrictHostKeyChecking=no -i $(ssh_key_file) $(ec2_user)@$(ec2_ip) << 'EOF'
          cd ~/mini-login-app
          git pull origin main
          npm install
          pm2 restart all
        EOF
      displayName: "🚀 Deploy to EC2"
